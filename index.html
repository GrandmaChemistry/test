<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ–å­¦æ¸¸æˆä¸­å¿ƒ | WONG</title>
    <!-- å¼•å…¥ Authing SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@authing/web/dist/authing-web-sdk.umd.min.js"></script>
    <style>
        /* [è¿™é‡Œä¿ç•™æ‚¨æ‰€æœ‰çš„CSSæ ·å¼ï¼Œå’Œä¹‹å‰å®Œå…¨ä¸€æ ·] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%); color: white; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 40px 0; background: rgba(0, 0, 0, 0.3); border-radius: 15px; margin-bottom: 40px; position: relative; }
        h1 { font-size: 3rem; color: #ffd700; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3); }
        .subtitle { font-size: 1.2rem; color: #bbbbff; max-width: 800px; margin: 0 auto; line-height: 1.6; }
        /* ... å…¶ä»–æ‰€æœ‰æ ·å¼ä¿æŒä¸å˜ ... */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”¬ åŒ–å­¦æ¸¸æˆä¸­å¿ƒ</h1>
            
            <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="login-container">
                <div style="text-align: center; padding: 20px;">
                    <div style="color: #ffd700; font-size: 1.1rem;">æ­£åœ¨æ£€æŸ¥ç™»å½•æœåŠ¡...</div>
                    <div style="color: #bbbbff; font-size: 0.9rem; margin-top: 10px;">ç½‘ç«™åœ°å€: grandmachemistry.github.io</div>
                </div>
            </div>
            
            <p class="subtitle">é€šè¿‡æœ‰è¶£çš„æ¸¸æˆå­¦ä¹ åŒ–å­¦çŸ¥è¯†ï¼Œè®©åŒ–å­¦å­¦ä¹ å˜å¾—ç”ŸåŠ¨æœ‰è¶£ï¼åŒ…å«ç¦»å­ååº”ã€æ™¶ä½“ç»“æ„å’ŒåŸå­æ„é€ åŸç†ç­‰æ ¸å¿ƒæ¦‚å¿µã€‚</p>
        </header>
        
        <!-- æ‚¨çš„æ¸¸æˆå†…å®¹ä¿æŒä¸å˜ -->
        <div class="stats-bar">...</div>
        <div class="games-grid">...</div>
        <footer>...</footer>
    </div>

    <script>
    // ==================== é…ç½®ä¿¡æ¯ (é’ˆå¯¹æ‚¨çš„åœ°å€ä¼˜åŒ–) ====================
    const AUTHING_CONFIG = {
        appId: "695f0afe3f11be56dbcfe03b",
        host: "https://wong.authing.cn",
        redirectUri: window.location.origin, // è‡ªåŠ¨è·å– https://grandmachemistry.github.io
        scope: "openid profile email phone"
    };
    
    // ==================== å¢å¼ºç‰ˆåˆå§‹åŒ– ====================
    let authing = null;
    let currentUser = null;
    let isInitialized = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸŒ ç½‘ç«™åœ°å€:', window.location.href);
        console.log('ğŸ”§ å›è°ƒåœ°å€:', window.location.origin);
        initializeAuthingWithRetry();
        checkLoginStatus();
        initGameCards();
    });
    
    // å¢å¼ºçš„åˆå§‹åŒ–å‡½æ•°ï¼Œå¸¦é‡è¯•æœºåˆ¶
    function initializeAuthingWithRetry(retryCount = 0) {
        const maxRetries = 3;
        
        try {
            authing = new AuthingWeb(AUTHING_CONFIG);
            isInitialized = true;
            console.log('âœ… Authing åˆå§‹åŒ–æˆåŠŸ');
            showLoginButton();
            
            // éªŒè¯é…ç½®
            console.log('ğŸ“‹ é…ç½®éªŒè¯:');
            console.log('- AppID:', AUTHING_CONFIG.appId ? 'âœ… å·²è®¾ç½®' : 'âŒ ç¼ºå¤±');
            console.log('- Host:', AUTHING_CONFIG.host ? 'âœ… å·²è®¾ç½®' : 'âŒ ç¼ºå¤±');
            console.log('- å›è°ƒåœ°å€:', window.location.origin);
            
        } catch (error) {
            console.error('âŒ Authing åˆå§‹åŒ–å¤±è´¥:', error.message);
            
            if (retryCount < maxRetries) {
                console.log(`ğŸ”„ ç¬¬ ${retryCount + 1} æ¬¡é‡è¯•...`);
                setTimeout(() => initializeAuthingWithRetry(retryCount + 1), 1000 * (retryCount + 1));
            } else {
                showErrorMessage('ç™»å½•æœåŠ¡åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å›è°ƒåœ°å€é…ç½®');
                showDemoLogin();
            }
        }
    }
    
    // æ˜¾ç¤ºç™»å½•æŒ‰é’®
    function showLoginButton() {
        const container = document.getElementById('login-container');
        if (!container) return;
        
        container.innerHTML = `
            <div style="text-align: center;">
                <button id="auth-login-btn" class="login-btn" style="
                    padding: 12px 35px;
                    background: linear-gradient(45deg, #2196F3, #1976D2);
                    color: white; border: none; border-radius: 25px;
                    font-size: 1.1rem; cursor: pointer;
                    display: inline-flex; align-items: center; gap: 10px;
                    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
                    transition: all 0.3s ease;">
                    <span style="font-size: 1.4rem;">ğŸ”</span>
                    <span>ç™»å½• / æ³¨å†Œ</span>
                </button>
                <p style="margin-top: 10px; color: #bbbbff; font-size: 0.9rem;">
                    ä½¿ç”¨æ‰‹æœºå·ã€é‚®ç®±æˆ–è´¦å·å¯†ç ç™»å½•
                </p>
                <p style="margin-top: 5px; color: #8888cc; font-size: 0.8rem;">
                    ç½‘ç«™åœ°å€: ${window.location.origin}
                </p>
            </div>
        `;
        
        document.getElementById('auth-login-btn').addEventListener('click', handleAuthLogin);
    }
    
    // å¤„ç†ç™»å½•
    async function handleAuthLogin() {
        if (!isInitialized || !authing) {
            alert('ç™»å½•æœåŠ¡æ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™...');
            initializeAuthingWithRetry();
            return;
        }
        
        const btn = document.getElementById('auth-login-btn');
        if (btn) {
            btn.innerHTML = '<span>æ­£åœ¨åŠ è½½ç™»å½•çª—å£...</span>';
            btn.disabled = true;
        }
        
        try {
            console.log('ğŸš€ å¼€å§‹ç™»å½•æµç¨‹...');
            const user = await authing.loginWithPopup();
            console.log('âœ… ç™»å½•æˆåŠŸ:', user);
            handleLoginSuccess(user);
            
        } catch (error) {
            console.error('ç™»å½•å¤±è´¥:', error);
            
            // ç”¨æˆ·å–æ¶ˆç™»å½•
            if (error.message === 'user closed popup') {
                if (btn) {
                    btn.innerHTML = '<span style="font-size: 1.4rem;">ğŸ”</span><span>ç™»å½• / æ³¨å†Œ</span>';
                    btn.disabled = false;
                }
                return;
            }
            
            // å…¶ä»–é”™è¯¯
            let errorMsg = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
            if (error.message.includes('redirect_uri')) {
                errorMsg = 'å›è°ƒåœ°å€é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥Authingæ§åˆ¶å°è®¾ç½®';
            } else if (error.message.includes('network')) {
                errorMsg = 'ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
            }
            
            alert(errorMsg);
            if (btn) {
                btn.innerHTML = '<span style="font-size: 1.4rem;">ğŸ”</span><span>ç™»å½• / æ³¨å†Œ</span>';
                btn.disabled = false;
            }
        }
    }
    
    // [å…¶ä»–å‡½æ•°ï¼šhandleLoginSuccess, showUserPanel, handleLogout ç­‰ä¿æŒä¸å˜]
    // ...
    
    // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
    function showErrorMessage(message) {
        const container = document.getElementById('login-container');
        if (!container) return;
        
        container.innerHTML = `
            <div style="text-align: center; color: #ff6b6b; padding: 20px; background: rgba(255, 107, 107, 0.1); border-radius: 10px;">
                <div style="font-size: 1.5rem;">âš ï¸</div>
                <div style="font-weight: bold; margin: 10px 0;">${message}</div>
                <div style="color: #bbbbff; font-size: 0.9rem; margin: 10px 0;">
                    è¯·æ£€æŸ¥ï¼š<br>
                    1. Authingå›è°ƒåœ°å€æ˜¯å¦é…ç½®ä¸º: <br>
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px;">
                        https://grandmachemistry.github.io/my-chemistry-games/
                    </code>
                </div>
                <button onclick="location.reload()" style="
                    padding: 8px 20px; margin-top: 10px;
                    background: #666; color: white;
                    border: none; border-radius: 15px;
                    cursor: pointer;">
                    åˆ·æ–°é¡µé¢é‡è¯•
                </button>
            </div>
        `;
    }
    
    // æ¼”ç¤ºæ¨¡å¼
    function showDemoLogin() {
        const container = document.getElementById('login-container');
        container.innerHTML = `
            <div style="text-align: center;">
                <button onclick="demoLogin()" class="login-btn" style="background: linear-gradient(45deg, #FF9800, #FF5722);">
                    <span style="font-size: 1.4rem;">ğŸ‘µ</span>
                    <span>ä½“éªŒæ¼”ç¤ºæ¨¡å¼</span>
                </button>
                <p style="margin-top: 10px; color: #ff9800; font-size: 0.9rem;">
                    å½“å‰ä½¿ç”¨æœ¬åœ°æ¼”ç¤ºæ¨¡å¼
                </p>
                <p style="margin-top: 5px; color: #8888cc; font-size: 0.8rem;">
                    è¦ä½¿ç”¨å®Œæ•´ç™»å½•ï¼Œè¯·æ­£ç¡®é…ç½®Authingå›è°ƒåœ°å€
                </p>
            </div>
        `;
    }
    
    function demoLogin() {
        currentUser = {
            id: 'demo_user_' + Math.random().toString(36).substr(2, 9),
            nickname: 'åŒ–å­¦å¥¶å¥¶ï¼ˆæ¼”ç¤ºï¼‰',
            email: 'demo@chemistry.com',
            photo: '',
            loginTime: new Date().toLocaleString()
        };
        
        localStorage.setItem('chem_game_user', JSON.stringify(currentUser));
        showUserPanel();
        showWelcomeMessage();
    }
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€ç­‰å…¶ä»–å‡½æ•°ä¿æŒä¸å˜...
    // [è¿™é‡Œçœç•¥äº†å…¶ä»–å‡½æ•°ï¼Œæ‚¨å¯ä»¥ä»ä¹‹å‰çš„ä»£ç ä¸­å¤åˆ¶è¿‡æ¥]
    
    </script>
</body>
</html>